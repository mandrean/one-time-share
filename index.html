<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>One Time Share</title>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0px 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background-color: #f0f0f0;
}
textarea {
    max-width: 100%;
}
</style>
<script>
var messageLimitBytes = {{.MessageLimitBytes}};
var retentionLimitMinutes = {{.RetentionLimitMinutes}};
var userToken = 'default';

const retentionOptions = [
    { value: 60, text: '1 hour' },
    { value: 360, text: '6 hours' },
    { value: 720, text: '12 hours' },
    { value: 1440, text: '1 day' },
    { value: 10080, text: '7 days' },
    { value: 43200, text: '30 days' },
    { value: 0, text: 'Forever' }
];

function getMessageSizeBytes() {
    return new TextEncoder().encode($('#message').val()).length;
}

function updateLimitText() {
    if (messageLimitBytes !== 0) {
        $('#count').text(getMessageSizeBytes() + '/' + messageLimitBytes + ' bytes');
    } else {
        $('#count').text('');
    }
}

function updatePasswordVisibility() {
    if ($('#password').is(':checked')) {
        $('#passwordField').show();
    } else {
        $('#passwordField').hide();
    }
}

function updatePageElementsFromLimits() {
    if (messageLimitBytes !== 0) {
        // We don't really care about bytes vs characters at this point
        $('#message').attr('maxlength', messageLimitBytes);
    } else {
        $('#message').removeAttr('maxlength');
    }
    updateLimitText();
    updatePasswordVisibility();

    $('#retention').empty();
    for (var i = 0; i < retentionOptions.length; i++) {
        if (retentionLimitMinutes === 0 || (retentionOptions[i].value!==0 && retentionOptions[i].value <= retentionLimitMinutes)) {
            var option = $('<option>').val(retentionOptions[i].value).text(retentionOptions[i].text);
            $('#retention').append(option);
        }
    }

    // Select the last available retention option that is not 0 (forever)
    if ($('#retention option').length > 0) {
        if ($('#retention option:last').val() !== '0') {
            $('#retention option:last').prop('selected', true);
        } else {
            $('#retention option').eq(-2).prop('selected', true);
        }
    }
}

function updateWithUserToken(token) {
    // send a get request to /limits
    $.get('/limits', { user_token: token }).done(function(data) {
        var response = JSON.parse(data);
        alert('data: ' + data);
        messageLimitBytes = response.message_limit_bytes;
        retentionLimitMinutes = response.retention_limit_minutes;
        updatePageElementsFromLimits();
        userToken = token;
    }).fail(function(error) {
        alert('Failed to update limits: ' + error.responseText);
    });
}

$(document).ready(function() {
    updatePageElementsFromLimits();

    $('#generate').click(function() {
        if ($('#message').val().length === 0) {
            alert('Please enter some text in Message.');
            return;
        }

        if (messageLimitBytes !== 0 && getMessageSizeBytes > messageLimitBytes) {
            alert('The message content is too long.');
            return;
        }

        // convert to base64
        message = btoa($('#message').val());

        $.post('/save', { user_token: userToken, message_data: message, retention: $('#retention').val()}).done(function(data) {
            $('#url').val(data)
            $('#url-div').show();
        })
        .fail(function(error) {
            alert('Failed to generate URL: ' + error.responseText);
        });
    });

    $('#copy').click(function() {
        $('#url').select();
        document.execCommand('copy');
    });

    $('#message').on('input', updateLimitText);

    $('#password').change(updatePasswordVisibility);

    $('#updateLimits').click(function() {
        updateWithUserToken($('#userToken').val());
    });
});
</script>
</head>
<body>
<h1>One Time Share</h1>

<div style="display: none;">
    <input type="text" id="userToken" placeholder="User token" autocomplete="off">
    <button id="updateLimits">Update limits</button>
</div>

<label for="message">Message:</label>
<textarea id="message" rows="4" cols="50" maxlength="1000" autocomplete="off"></textarea>
<div id="count" style="margin-bottom: 10px;">0/? bytes</div>

<div>
    <label for="retention">Retention:</label>
    <select id="retention" style="margin-bottom: 10px;"></select>
</div>
<!-- Password protection is not implemented yet
<div style="margin-bottom: 10px;">
    <div class="item">
        <input type="checkbox" id="password" autocomplete="off">
        <label for="password">Encrypt with password</label>
    </div>

    <input type="password" id="passwordField" placeholder="Password" style="display: none;" autocomplete="off">
</div>
-->
<button id="generate" style="margin-bottom: 10px;">Generate URL</button>

<div id="url-div" style="max-width: 100%;display: none;">
    <input id="url" type="text" size="50" readonly style="max-width: 100%" autocomplete="off">
    <button id="copy">Copy URL</button>
</div>

<div id="footer" style="margin-top: 20px; text-align: center; font-size: 0.8em; color: #888;">
    <p>One Time Share - <a href="1ts.dev">1ts.dev</a>. <a href="https://github.com/gameraccoon/one-time-share">Source code</a></p>
</div>
</body>
</html>